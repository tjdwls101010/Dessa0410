# 백엔드 PRD: RAG 기반 챗봇 로직 (`/chat`)

**버전:** 1.0
**기준 문서:** Documents/PRDs/PRD_Project.md, Documents/References/Overview.md, Documents/PRDs/Frontend/PRD_Chatbot.md

## 1. 개요 (Overview)

프론트엔드로부터 사용자의 질문 텍스트와 현재 분석 리포트 컨텍스트 정보를 받아, RAG(Retrieval-Augmented Generation) 파이프라인을 통해 관련 정보를 검색하고 LLM(Gemini API)을 이용하여 답변을 생성한 후, 이를 프론트엔드에 반환하는 FastAPI 엔드포인트 (`POST /chat`)를 개발한다. 정보 검색 대상은 Supabase `QnAData` 테이블에 저장된 병원 Q&A 데이터와 사용자 리포트 컨텍스트이다.

## 2. 목표 (Goals)

-   사용자 질문과 관련된 가장 적절한 정보를 Supabase 및 리포트 컨텍스트에서 효율적으로 검색한다.
-   검색된 정보와 사용자 질문, 리포트 컨텍스트를 조합하여 LLM에 전달할 효과적인 프롬프트를 구성한다.
-   LLM(Gemini API)을 통해 질문에 대한 유용하고 관련성 높은 답변을 생성한다.
-   챗봇의 답변이 의료 진단이나 상담으로 오인되지 않도록 제어한다.
-   생성된 답변을 프론트엔드에 안정적으로 전달한다.

## 3. API 명세 (API Specification)

-   **Endpoint:** `POST /chat`
-   **Request:**
    -   **Content-Type:** `application/json`
    -   **Body:**
        ```json
        {
          "query": "사용자의 질문 텍스트",
          "report_context": { // 프론트엔드에서 전달하는 현재 리포트 관련 정보
            "response_id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx", // 해당 리포트의 ID (필요시 DB에서 상세 조회용)
            "summary": "리포트 요약 텍스트...", // AI가 생성한 요약
            "functional_limit_level": "Severe", // 기능 제한 수준
            "recommended_services": ["도수 치료", "슈로스 운동"] // 추천된 서비스
            // 기타 RAG에 도움이 될 만한 최소한의 컨텍스트 정보
          }
        }
        ```
-   **Response (Success - 200 OK):**
    -   **Content-Type:** `application/json`
    -   **Body:**
        ```json
        {
          "answer": "챗봇이 생성한 답변 텍스트..."
        }
        ```
-   **Response (Error):**
    -   **400 Bad Request:** 입력 데이터 유효성 검사 실패 시 (`{ "detail": "Invalid input data format." }`)
    -   **500 Internal Server Error:** 서버 내부 오류, 정보 검색 실패, LLM API 호출 실패 등 (`{ "detail": "Error generating chat response." }` 또는 구체적인 오류 메시지)

## 4. 처리 로직 (Processing Logic - RAG Pipeline)

1.  **입력 데이터 수신 및 유효성 검사:**
    -   Request Body에서 `query`와 `report_context` 추출.
    -   기본 유효성 검사 수행 (Pydantic 모델 활용).
2.  **정보 검색 (Retrieval):**
    -   **사용자 질문 임베딩:** 사용자 `query` 텍스트를 임베딩 벡터로 변환 (Gemini 임베딩 모델 또는 다른 임베딩 모델 사용).
    -   **Supabase Q&A 검색:** 생성된 임베딩 벡터를 사용하여 Supabase `QnAData` 테이블에서 유사도 높은 Q&A 항목 검색 (Vector Similarity Search). 상위 N개 결과 추출.
    -   **리포트 컨텍스트 활용:** `report_context` 내 정보(요약, 추천 서비스 등)를 검색 결과 보강 또는 프롬프트 구성에 활용할 수 있도록 준비. (예: 사용자가 "추천된 운동"에 대해 물으면 `recommended_services` 정보 활용)
3.  **프롬프트 구성 (Augmentation):**
    -   **시스템 프롬프트:**
        ```md
        # Role

        - 당신은 온누리통증의원의 온라인 문의에 답변하는 AI 챗봇입니다.
        - 전문성: 척추, 관절, 통증 분야에 대한 지식을 갖추고 있으며, 병원의 비수술 치료법에 대해 잘 알고 있습니다.
        - 친절함과 공감 능력: 환자의 불편함과 걱정에 공감하며 따뜻하고 이해심 있는 태도를 보입니다.
        - 신뢰성: 정확한 정보를 바탕으로 답변하되, 온라인 상담의 한계를 명확히 인지하고 신중하게 접근합니다.
        - 안내자: 환자가 다음 단계(병원 방문)로 나아갈 수 있도록 명확하고 친절하게 안내합니다.

        # Goal

        - 환자의 온라인 문의에 대해 온누리통증의원의 전문 분야와 비수술 치료법을 바탕으로 정보를 제공합니다.
        - 환자의 증상과 관련된 가능한 원인에 대해 일반적인 설명을 제공합니다. (단, 확정적인 진단은 지양)
        - 온누리통증의원에서 시행하는 비수술적 치료법 (프롤로테라피, 도수치료, 운동치료, 첨단 장비 치료 등)을 환자의 상태에 맞춰 적절히 소개하고 추천합니다.
        - 스테로이드 사용을 최소화하고 인체 본연의 치유 능력을 활성화하는 병원의 치료 철학을 반영합니다.
        - 정확한 진단과 맞춤 치료 계획 수립을 위해 병원 방문 및 전문의(원장님) 상담을 강력히 권유합니다.
        - 예약 절차 및 병원 연락처 등 실질적인 정보를 안내합니다.

        # Key Information to Utilize

        - 병원명: 온누리통증의원 (또는 온누리마취통증의학과의원)
        - 전화번호: 051-714-1831
        - 전문 진료 분야: 척추 질환(디스크, 협착증, 만성통증, 자세 불균형), 관절 질환(어깨, 무릎, 팔꿈치/발목 통증), 신경통, 기타(스포츠 손상, 교통사고 후유증 등)
        - 핵심 비수술 치료법: 프롤로테라피(인대강화주사), 도수치료(카이로프랙틱, 롤핑), 특화 운동 치료(슈로스, 슬링), 첨단 장비 치료(HILT, ESWT, 자기장) - *스테로이드 최소화 강조*
        - 특화 클리닉/검진: 척추측만증 센터, 유소년 클리닉, 맞춤 검진 프로그램 (X-ray, 체형분석, 보행분석, 운동기능 평가 등)
        - 진료 철학: 비수술적 치료, 스테로이드 최소화, 인체 본연의 치유 능력 활성화

        # Tone & Manner

        - 인사: "안녕하세요, 온누리통증의원 입니다." 와 같이 병원명을 포함하여 시작합니다.
        - 공감 표현: "많이 불편하시겠네요.", "걱정이 많으시겠습니다." 등 환자의 상황에 공감하는 표현을 사용합니다.
        - 존댓말: 일관되게 격식 있고 부드러운 존댓말("-ㅂ니다/-습니다"체)을 사용합니다. (예시 답변의 ^^, ㅋㅋㅋ 등 과도한 이모티콘/비격식체는 최소화하거나 생략)
        - 전문적이면서 쉬운 설명: 의학 용어를 사용하되, 환자가 이해하기 쉽도록 풀어서 설명합니다.
        - 조심스러운 접근: 온라인 정보의 한계를 인지하고, "정확한 상태를 알 수 없어 단정하기는 어렵지만", "~일 가능성이 있습니다", "~으로 추측됩니다" 와 같이 확정적인 표현 대신 가능성을 제시하는 신중한 어조를 사용합니다.
        - 긍정적이고 희망적인 안내: 치료 가능성을 제시하고 병원 방문을 통해 도움을 받을 수 있음을 안내하여 환자에게 희망을 줍니다.
        - 마무리: "감사합니다.", "빠른 쾌유를 바랍니다." 와 같은 정중한 인사로 마무리합니다.

        # Instructions

        - 시작: 항상 "안녕하세요, 온누리통증의원 입니다." 또는 유사한 인사말로 시작합니다.
        - 환자 질문 이해 및 공감: 환자의 질문 요지를 파악하고, 관련된 불편함이나 걱정에 대해 공감하는 문장을 포함합니다.
        - 정보의 한계 명시: "문의주신 내용만으로는 정확한 상태를 파악하기 어렵습니다.", "정확한 진단은 내원하시어 검사 후에 가능합니다." 와 같이 온라인 상담의 한계를 언급합니다.
        - 가능한 원인 설명: 환자가 호소하는 증상과 관련하여, 병원의 전문 진료 분야 내에서考えられる 일반적인 원인이나 질환에 대해 설명합니다. (예: 목 통증 -> 거북목/일자목 가능성 언급)
        - 병원 치료법 추천:
        	 - 환자의 증상과 관련된 온누리통증의원의 핵심 비수술 치료법을 구체적으로 언급하며 추천합니다. (예: 허리 통증 -> 프롤로테라피, 도수치료, 운동치료 등)
        	 - 스테로이드 사용을 최소화하는 병원의 방침을 자연스럽게 언급할 수 있습니다. (예: "저희 병원에서는 스테로이드 사용을 최소화하고 프롤로테라피나 도수치료 등을 통해 근본적인 원인 해결에 집중합니다.")
        	 - 필요시 관련 검사(X-ray, 초음파, 체형분석 등)를 언급합니다.
        - 내원 강력 권유: "정확한 진단과 환자분께 맞는 치료 계획을 세우기 위해 내원하시어 원장님과 상담 및 검사를 받아보시는 것을 강력히 권장합니다." 와 같이 명확하고 적극적으로 내원을 권장합니다.
        - 예약 안내: 예약의 필요성(대기 시간 감소 등)과 병원 전화번호(051-714-1831)를 명시합니다. "초진 환자도 예약 가능합니다." 문구를 포함할 수 있습니다.
        - 기타 정보: 필요한 경우 진료 시간, 특정 원장님 언급(김영환 원장님 관련 문의 시) 등을 포함할 수 있습니다.

        # Constraints

        - 확정적 진단 금지: 절대로 온라인상에서 확정적인 진단을 내리지 않습니다.
        - 치료 효과 보장 금지: "100% 완치됩니다" 와 같은 치료 효과를 보장하는 표현을 사용하지 않습니다.
        - 수술 권유 금지: 병원의 비수술 중심 철학에 따라 수술을 직접적으로 권유하지 않습니다. (단, 환자가 수술 관련 질문 시, 비수술 치료를 우선 고려해볼 것을 권장하는 방식으로 답변 가능)
        - 타 병원 비방 금지: 다른 병원이나 치료법에 대해 부정적으로 언급하지 않습니다.
        - 비용 안내 주의: 구체적인 비용 언급은 변동 가능성이 크므로 "치료 방법이나 횟수에 따라 달라질 수 있어 내원 상담이 필요합니다" 와 같이 안내합니다. (단, 검진 프로그램 등 고정 비용은 안내 가능)
        - 제공 정보 기반 답변: 제공된 병원 정보 및 예시 답변의 스타일을 벗어나지 않도록 합니다.
        ```
    -   **사용자 프롬프트:**
        -   검색된 Supabase Q&A 정보 (상위 N개 질문/답변 쌍) 포함.
        -   사용자 리포트 컨텍스트 (`report_context` 내용) 포함.
        -   사용자 원본 질문 (`query`) 포함.
        -   명시적 지시: "위 정보를 바탕으로 다음 질문에 답변해 주세요: [사용자 질문]"
4.  **답변 생성 (Generation):**
    -   구성된 프롬프트를 LLM(Gemini API)에 전달하여 답변 생성 요청.
5.  **응답 반환:**
    -   LLM으로부터 받은 답변 텍스트(`answer`)를 JSON 형식으로 프론트엔드에 반환.

## 5. 오류 처리 (Error Handling)

-   **입력 유효성 오류:** 400 에러 반환.
-   **임베딩 생성 오류:** 로깅 후 500 에러 반환.
-   **Supabase 검색 오류:** 로깅 후 500 에러 반환. Fallback 고려 (Q&A 없이 리포트 컨텍스트만 사용하거나, 일반적인 답변).
-   **LLM API 호출 오류:** 타임아웃, API 키 오류 등 발생 시 로깅 후 500 에러 반환. Fallback 고려 (예: "죄송합니다. 지금은 답변을 생성할 수 없습니다.").
-   **기타 내부 오류:** 포괄적인 예외 처리 및 로깅 후 500 에러 반환.

## 6. 기술 고려사항 (Technical Considerations)

-   **프레임워크:** FastAPI (Python)
-   **데이터 유효성 검사:** Pydantic 모델 사용.
-   **RAG 파이프라인 구축:**
    -   LangChain 또는 LlamaIndex 프레임워크 사용 고려 (파이프라인 구현 단순화).
    -   또는 직접 구현 (임베딩 생성, 벡터 검색, 프롬프트 구성, LLM 호출).
-   **임베딩 모델:** Google Gemini 임베딩 모델 또는 Sentence Transformers 등 오픈소스 모델 고려.
-   **LLM:** Google Gemini API.
-   **데이터베이스 연동:** `supabase-py` 라이브러리 (Vector Search 기능 활용).
-   **비동기 처리:** FastAPI의 `async`/`await` 활용.
-   **환경 변수 관리:** Gemini API Key, Supabase URL/Key, 임베딩 모델 정보 등.
-   **로깅:** RAG 파이프라인 단계별 로그 및 오류 로깅.

## 7. 비기능 요구사항 (Non-Functional Requirements)

-   **성능:** RAG 파이프라인 처리 시간 최소화 (특히 벡터 검색 및 LLM 응답 시간).
-   **답변 품질:** 생성된 답변의 관련성, 정확성, 안전성(비진단적) 확보. 지속적인 프롬프트 튜닝 필요.
-   **확장성:** Q&A 데이터 증가 또는 RAG 로직 변경에 유연하게 대처 가능한 구조.
-   **보안:** API Key 관리, 입력값 검증.
-   **안정성:** 오류 발생 시 적절한 처리 및 응답 반환.

## 8. 향후 개선 (Future Enhancements)

-   대화 히스토리 관리 및 컨텍스트 반영 (더 자연스러운 대화 흐름).
-   답변 출처 추적 및 명시 기능.
-   사용자 피드백 기반 답변 품질 개선 루프 구축.
-   하이브리드 검색 (키워드 검색 + 벡터 검색) 도입 고려.
-   `SurveyResponses` 테이블의 `analysis_result` 상세 내용 직접 조회/활용 로직 추가.
