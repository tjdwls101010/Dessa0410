## 제품 요구사항 명세서 (PRD): 온누리마취통증의학과 예비 환자 자가 점검 및 안내 시스템

**버전:** 0.1 (초안)
**작성일:** 2023-10-27
**작성자:** (베테랑 PM/프롬프트 엔지니어/데이터 사이언티스트)

### 1. 개요 (Overview)

본 문서는 온누리마취통증의학과 방문을 고려하는 잠재 환자들이 자신의 통증 상태를 스스로 점검하고, 병원 방문 필요성 및 적합한 치료 옵션에 대한 예비 정보를 얻을 수 있도록 돕는 웹 기반 시스템의 개발 요구사항을 정의합니다. 사용자가 제공된 설문에 응답하면, 입력된 정보를 바탕으로 AI(Gemini API)와 규칙 기반 로직을 활용하여 분석 리포트를 생성하고, 관련 정보를 제공하는 챗봇 기능을 제공합니다.

**핵심 목표:** 사용자의 자가 점검을 돕고, 병원 방문 및 전문 진료의 필요성을 인지시켜 내원을 유도하는 것. **본 시스템은 의료 진단 도구가 아니며, 제공되는 정보는 참고용임을 명확히 합니다.**

### 2. 목표 (Goals)

- **사용자:** 자신의 통증 양상, 심각도, 기능 제한 수준을 객관적인 설문을 통해 자가 점검할 수 있다.
- **사용자:** 분석 결과를 시각화된 리포트로 확인하고, 잠재적인 통증 원인 및 온누리마취통증의학과의 관련 치료법(슈로스, 도수치료 등)에 대한 예비 정보를 얻을 수 있다.
- **사용자:** 생성된 리포트 내용 및 병원 정보에 대해 궁금한 점을 챗봇을 통해 문의하고 안내받을 수 있다.
- **병원 (간접적):** 잠재 환자들에게 병원과 치료법을 효과적으로 알리고, 정보에 기반한 내원 결정을 유도하여 병원 운영 효율화에 기여한다.
- **개발 (과제):** 데이터 수집(설문), AI 기반 분석(Gemini), 결과 시각화(리포트), 정보 제공(챗봇) 등 데이터 사이언스 기술 적용 프로세스를 경험하고 프로토타입을 개발한다.

### 3. 사용자 (Users)

- **주요 사용자:** 목, 허리, 어깨 등 근골격계 통증이나 불편함을 느끼고 있으며, 온누리마취통증의학과 방문을 고려 중인 잠재 환자.

### 4. 주요 기능 (Key Features)

#### 4.1. 웹 기반 설문 시스템 (Frontend: Next.js, Backend: FastAPI)

- **기능:** 사용자가 통증 관련 설문(제공된 예시 문항 기반 약 30~35개)에 응답하고 제출하는 인터페이스.
    - **세부 요구사항:**
        - 사용자 친화적인 단계별 설문 진행 방식 (한 화면에 너무 많은 문항 X).
        - 진행률 표시 바 제공.
        - 각 문항 유형(단일 선택, 다중 선택, 숫자 입력 등)에 맞는 입력 컴포넌트 구현.
        - 설문 시작 전, 본 설문이 **의료 진단이 아니며 참고용**임을 명확히 고지하는 안내 페이지/팝업 표시.
        - 모든 필수 문항 응답 완료 시 '결과 분석 요청' 버튼 활성화.
        - 설문 응답 데이터는 JSON 형태로 구조화되어 백엔드 API(`/submit_survey`)로 전송.
    - **기술 고려사항:**
        - Tally Form 대신 Next.js 내에서 직접 구현하여 데이터 흐름 제어 및 UI 커스터마이징 용이성 확보.
        - 상태 관리 라이브러리(예: Zustand, Jotai)를 사용하여 설문 진행 상태 및 응답 데이터 관리.

#### 4.2. 설문 결과 분석 및 처리 (Backend: FastAPI, AI: Gemini API)

- **기능:** 제출된 설문 데이터를 받아 AI와 규칙 기반 로직을 통해 분석하고, 구조화된 분석 결과를 생성.
    - **세부 요구사항:**
        - FastAPI 엔드포인트 (`POST /submit_survey`) 구현.
        - 입력: 설문 응답 JSON 데이터.
        - 처리 로직:
            1.  **규칙 기반 분석 (Rule-based Logic):**
                - Red Flag 징후(설문 F항목) 체크 여부 확인 및 플래그 설정.
                - ODI/NDI 개념 기반 기능 제한 점수 계산 (설문 D항목 점수 합산/변환).
                - 통증 기간(B6), 강도(C11, C12) 등 주요 지표 추출.
                - 특정 응답 조합 기반의 사전 정의된 규칙 적용 (예: 특정 통증 양상 + 방사통 -> 신경학적 검사 고려 메시지 추가).
            2.  **AI 분석 (Gemini API 연동):**
                - 설문 응답 데이터를 적절한 프롬프트로 구성하여 Gemini API 호출.
                - 분석 목표: 통증 심각도/만성화 가능성 평가, 기능 제한 수준 해석, 잠재적 기여 요인(자세, 생활 습관 등) 추론, 통증 양상 분류(예: 신경병증성 통증 가능성), 적합 가능성이 높은 병원 치료법(슈로스, 도수치료 등 명시적 언급) 제안.
                - Gemini API 응답(텍스트)을 파싱하여 필요한 정보 추출.
            3.  **결과 통합:** 규칙 기반 분석 결과와 AI 분석 결과를 통합하여 최종 분석 결과 JSON 객체 생성. 이 객체는 리포트 생성에 필요한 모든 정보를 포함해야 함 (아래 '데이터 모델' 참고).
        - 출력: 분석 결과 JSON 객체. (예: `{ "red_flags": ["..."], "functional_limit_score": 75, "pain_severity_avg": 7, "potential_causes": ["..."], "pain_pattern": "...", "recommended_services": ["도수 치료", "보행 분석"], "report_summary_text": "...", "raw_gemini_output": "..." }`)
    - **기술 고려사항:**
        - Gemini API Key 등 민감 정보는 환경 변수 또는 보안 관리 도구를 통해 관리.
        - 오류 처리: Gemini API 호출 실패, 타임아웃 등에 대한 예외 처리 로직 구현.
        - 비동기 처리: API 호출 시간이 길어질 수 있으므로 FastAPI의 비동기(async/await) 기능 활용.

#### 4.3. 분석 리포트 생성 및 조회 (Frontend: Next.js)

- **기능:** 백엔드로부터 받은 분석 결과 JSON을 바탕으로 시각적이고 이해하기 쉬운 웹 리포트 페이지(html, css)를 동적으로 생성하여 사용자에게 보여줌.
    - **세부 요구사항:**
        - 분석 결과 데이터를 받아 UI 컴포넌트에 매핑하여 렌더링.
        - **시각화 요소 포함:**
            - 통증 부위 시각화: 인체 그림 위에 사용자가 선택한 통증 부위(B4, B5) 표시. (라이브러리: `react-body-highlighter` 또는 유사 SVG 기반 구현 고려)
            - 기능 제한 대시보드: 계산된 점수 및 항목별 응답 시각화 (예: 막대 그래프, 레이더 차트). (라이브러리: `Recharts`, `Chart.js`)
            - 통증 강도/양상 요약: 텍스트, 아이콘, 간단한 그래프로 표시.
            - Red Flag 징후: 발견 시 눈에 띄는 경고 메시지 박스 (색상, 아이콘 활용).
            - 추천 검사/치료법: 리스트 형태로 보여주고, 각 항목 클릭 시 간단한 설명 제공 (팝업 또는 확장 패널).
        - 개인화된 설명: 사용자의 응답(예: "오래 앉아있을 때 통증이 심해진다고 하셨는데...")을 인용하며 분석 결과 및 추천 이유 설명.
        - **의료 진단 아님** 및 **전문의 상담 필수** 문구 리포트 상단/하단에 명확하고 반복적으로 고지.
        - 리포트 PDF 저장 기능 제공 (클라이언트 측 라이브러리 `jsPDF`, `html2canvas` 활용).
    - **기술 고려사항:**
        - Next.js의 서버 컴포넌트 또는 클라이언트 컴포넌트를 적절히 활용하여 데이터 페칭 및 렌더링 최적화.
        - 반응형 디자인 적용하여 다양한 화면 크기(데스크탑, 모바일) 지원.

#### 4.4. RAG 기반 챗봇 (Frontend: Next.js, Backend: FastAPI, DB: Supabase)

- **기능:** 생성된 리포트 내용 및 사전에 입력된 병원 Q&A 데이터를 기반으로 사용자의 질문에 답변하는 챗봇 인터페이스.
    - **세부 요구사항:**
        - **챗봇 인터페이스 (Frontend):**
            - 텍스트 입력창, 대화 내용 표시 영역으로 구성된 표준 챗 UI.
            - 사용자가 질문 입력 시 백엔드 API (`/chat`) 호출.
            - 챗봇의 답변을 대화창에 표시.
        - **챗봇 로직 (Backend - FastAPI `/chat` 엔드포인트):**
            - 입력: 사용자 질문 텍스트, 현재 사용자의 분석 리포트 요약/주요 내용 (컨텍스트).
            - 처리 로직 (RAG):
                1.  **정보 검색 (Retrieval):**
                    - 사용자 질문과 관련된 정보를 Supabase `QnAData` 테이블에서 검색 (Vector Similarity Search 활용).
                    - 제공된 리포트 컨텍스트 정보 활용.
                2.  **프롬프트 구성 (Augmentation):** 검색된 Q&A 정보, 리포트 컨텍스트, 사용자 질문을 조합하여 LLM(Gemini)에 전달할 프롬프트 생성. 시스템 프롬프트에는 챗봇의 역할(정보 제공 보조, 진단 불가) 및 병원 Q&A 기반 답변 유도 지침 포함.
                3.  **답변 생성 (Generation):** 구성된 프롬프트로 LLM(Gemini) API 호출하여 답변 생성.
            - 출력: 챗봇 답변 텍스트.
        - **Q&A 데이터 관리 (Supabase):**
            - 병원 웹사이트 Q&A 내용을 구조화하여 `QnAData` 테이블에 저장.
            - 텍스트 임베딩 생성 및 저장 (Supabase Vector 또는 별도 프로세스).
        - **챗봇 역할 명시:** 챗봇 인터페이스 상단 또는 초기 메시지에 "의료 상담/진단을 제공하지 않으며, 정보 안내 목적으로만 사용됩니다." 문구 명시.
    - **기술 고려사항:**
        - Supabase Vector 기능을 활용한 효율적인 유사성 검색 구현.
        - LangChain 또는 유사 프레임워크를 사용하여 RAG 파이프라인 구축 고려.
        - 챗봇 대화 기록 저장 여부 결정 (개인 정보 보호 고려). 초기 버전에서는 저장하지 않는 것을 권장.

### 5. 기술 스택 (Technology Stack)

- **Frontend:** Next.js (React)
- **Backend:** FastAPI (Python)
- **Database:** Supabase (PostgreSQL + Vector + Auth(선택) + Storage(선택))
- **AI:** Google Gemini API
- **기타 라이브러리:** (UI 컴포넌트, 차트, PDF 생성, HTTP 클라이언트 등)

### 6. 데이터 모델 (Data Models - Supabase)

- **`SurveyResponses` 테이블:** 사용자의 설문 응답 및 분석 결과 저장
    - `id`: UUID (Primary Key)
    - `created_at`: TIMESTAMPZ (Default: `now()`)
    - `responses`: JSONB (사용자의 전체 설문 응답 내용)
    - `analysis_result`: JSONB (백엔드에서 생성한 분석 결과 객체)
    - `is_test_data`: BOOLEAN (Default: `true`, 실제 환자 데이터 아님을 명시)
    - `report_access_key`: TEXT (Unique, 선택적: 특정 사용자에게 리포트 접근 링크 제공 시)

- **`QnAData` 테이블:** 챗봇 RAG를 위한 병원 Q&A 데이터
    - `id`: UUID (Primary Key)
    - `question`: TEXT
    - `answer`: TEXT
    - `category`: TEXT (Optional, 분류용)
    - `embedding`: VECTOR (Question 또는 Question+Answer 텍스트의 임베딩 벡터) - Supabase Vector 타입 사용
    - `created_at`: TIMESTAMPZ (Default: `now()`)

### 7. API 명세 (API Specifications - FastAPI)

- **`POST /submit_survey`**
    - **Request Body:** `{ "responses": { ... } }` (설문 응답 JSON)
    - **Response Body (Success):** `{ "analysis_result": { ... }, "response_id": "..." }` (분석 결과 JSON 및 응답 ID)
    - **Response Body (Error):** `{ "detail": "Error message" }` (오류 발생 시)
    - **Description:** 설문 응답을 받아 분석(규칙+AI)을 수행하고 결과를 반환.

- **`POST /chat`**
    - **Request Body:** `{ "query": "...", "report_context": { ... } }` (사용자 질문 및 리포트 컨텍스트)
    - **Response Body (Success):** `{ "answer": "..." }` (챗봇 답변 텍스트)
    - **Response Body (Error):** `{ "detail": "Error message" }`
    - **Description:** 사용자 질문과 리포트 컨텍스트를 기반으로 RAG를 수행하여 챗봇 답변 생성.

### 8. UI/UX 고려사항 (UI/UX Considerations)

- **전체적인 톤앤매너:** 신뢰감을 주면서도 사용자에게 위압감을 주지 않는 디자인. 의료 관련 서비스이므로 차분하고 전문적인 느낌. (참고: 병원 웹사이트가 있다면 해당 디자인과 일관성 유지)
    - **색상:** 파란색, 녹색 계열의 안정감을 주는 색상과 흰색, 회색을 주로 사용. 강조 색상(Red Flag 등)은 주의를 끌면서도 과하지 않게 사용.
    - **레이아웃:** 직관적이고 간결한 레이아웃. 정보의 위계질서를 명확히 하여 사용자가 쉽게 이해하도록 구성. 충분한 여백 활용.
- **설문:**
    - **참고 UI/UX:** Typeform (https://www.typeform.com), Tally (https://tally.so) - 부드러운 전환 애니메이션, 명확한 문항 표시, 쉬운 입력 방식.
    - **개선 제안:** 각 질문 하단에 간단한 부연 설명이나 예시를 제공하여 사용자의 이해를 돕는 것 고려.
- **리포트:**
    - **참고 UI/UX:** 건강 관리 앱 대시보드 (예: Apple Health 앱, Fitbit 앱 - https://www.fitbit.com), 증상 체커 결과 페이지 (예: WebMD Symptom Checker - https://symptoms.webmd.com/ - 레이아웃 참고).
    - **개선 제안:** 복잡한 의학 용어 대신 쉬운 단어 사용. 시각화 자료에 대한 명확한 레이블과 설명 제공. "이 결과는 참고용이며, 정확한 진단은 의사와 상담하세요" 문구를 눈에 잘 띄게 배치.
- **챗봇:**
    - **참고 UI/UX:** Intercom (https://www.intercom.com), Drift (https://www.drift.com) - 표준적인 챗 인터페이스.
    - **개선 제안:** 챗봇이 답변 생성 중임을 나타내는 로딩 인디케이터 제공. 답변 출처(예: "병원 FAQ 기반 정보입니다")를 명시하는 것 고려.

### 9. 제약 조건 및 고려 사항 (Constraints & Considerations)

- **의료 데이터 제약:** 실제 환자 데이터 접근 불가. 모든 데이터는 사용자가 직접 입력한 설문 기반이며, 시스템은 이를 바탕으로 **예비 정보**만을 제공함.
- **비진단적 성격 명확화:** 시스템의 모든 단계(시작, 설문 중, 리포트, 챗봇)에서 본 서비스가 의료 진단/상담을 대체할 수 없음을 명확하고 반복적으로 고지해야 함. 법적 책임 문제 방지를 위해 중요.
- **AI 모델의 한계:** Gemini 등 LLM은 유용하지만 '환각(Hallucination)' 현상이나 부정확한 정보를 생성할 수 있음. 규칙 기반 로직 병행 및 결과 검증 장치(Red Flag 우선 처리 등)가 필수적. 프롬프트 엔지니어링을 통해 결과의 일관성과 정확성을 높여야 함.
- **데이터 프라이버시:** 사용자 식별 정보를 최소화하고, 저장되는 데이터(설문 응답, 분석 결과)에 대한 관리 방안 고려. (초기 버전은 익명 사용 권장)
- **확장성:** 향후 기능 추가(사용자 계정, 이력 관리 등)를 고려한 유연한 아키텍처 설계.
- **보안:** API Key 등 민감 정보 관리 철저. API 엔드포인트에 대한 기본적인 보안 조치(Rate Limiting 등) 고려.

### 10. 향후 개선 방향 (Future Enhancements)

- **사용자 계정 및 이력 관리:** 사용자가 과거 결과를 조회하고 시간 경과에 따른 변화 추적 기능.
- **데이터 기반 개선:** (익명화된) 사용자 응답 패턴 및 결과 피드백을 분석하여 설문 문항 및 분석 로직 개선.
- **고도화된 분석:** 더 많은 종류의 통증 평가 도구(예: DN4, PSQ 등) 통합 및 분석 모델 정교화.
- **병원 시스템 연동 (장기적):** 실제 병원 예약 시스템과 연동하여 리포트 확인 후 바로 예약으로 이어지는 기능 (데이터 프라이버시 및 규제 준수 필수).
- **다국어 지원:** 필요시 다른 언어 지원 추가.